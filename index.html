<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SaveMySpot – Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.css"/>
  <style>
    html,body{margin:0;padding:0;height:100%}
    #map{width:100%;height:100%}
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.js"></script>
  <script>
    /* 1. start wide (so tiles always show) */
    const map = L.map('map').setView([35.511, 33.895], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    /* 2. FORCE permission prompt + zoom to street (19 = house level) */
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setView([lng, lat], 19);                // 19 = street-level tiles
          L.marker([lng, lat], {color: 'blue'}).addTo(map)
            .bindPopup('You are here').openPopup();
        },
        err => {
          alert('Location denied – using city centre');
          map.setView([35.511, 33.895], 15);
        },
        {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
      );
    } else {
      alert('Geolocation not supported – using city centre');
      map.setView([35.511, 33.895], 15);
    }

    /* 3. load existing pins */
    fetch('pins.json').then(r => r.json()).then(arr =>
      arr.forEach(p => L.marker([p.lng, p.lat], {color: 'green'}).addTo(map)));

    /* 4. scout: long-press → drop pin */
    map.on('contextmenu', e => {
      const lat = e.latlng.lat, lng = e.latlng.lng;
      L.marker([lng, lat], {color: 'green'}).addTo(map);
      window.open(`https://t.me/savemyspotmainbot?start=${lat},${lng}`, '_blank');
      alert('Pin dropped – finish inside the bot chat!');
    });

    /* 5. driver: click green pin → pay 20 Stars */
    map.on('click', e => {
      const marker = e.originalEvent.target.closest('.leaflet-marker-icon');
      if (!marker) return;
      L.popup()
        .setLatLng(e.latlng)
        .setContent(`<b>Spot ready</b><br><a href="https://t.me/\(BEEtUVjOKVH5BAAATCVL1nNAsX8" target="_blank">Rent 2 h – 20 ⭐</a>`)
        .openOn(map);
    });
  </script>
</body>
</html>
